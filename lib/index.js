(()=>{"use strict";var e={850:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FreeeAPIClient=void 0;const a=r(305);t.FreeeAPIClient=class{constructor(e,t){this.tokenManager=e,this.axios=t}get(e,t,r,a){return this.tokenManager.get(r).then((r=>{const i=Object.assign({Authorization:`Bearer ${r}`,"X-Api-Version":"2020-06-15","Content-Type":"application/json"},a);return this.axios.get(e,{params:t,headers:i})}))}post(e,t,r,i){return this.tokenManager.get(r).then((r=>{let s=t,n={},o="application/json";if("api/1/receipts"===e){const e=new a;Object.keys(t).forEach((r=>{e.append(r,t[r])})),s=e,n=e.getHeaders(),o="multipart/form-data"}n.Authorization=`Bearer ${r}`,n["X-Api-Version"]="2020-06-15",n["Content-Type"]=o;const c=Object.assign(Object.assign({},n),i);return this.axios.post(e,s,{maxContentLength:104857600,headers:c})}))}put(e,t,r,a){return this.tokenManager.get(r).then((r=>{const i=Object.assign({Authorization:`Bearer ${r}`,"X-Api-Version":"2020-06-15","Content-Type":"application/json"},a);return this.axios.put(e,t,{headers:i})}))}delete(e,t,r,a){return this.tokenManager.get(r).then((r=>{const i=Object.assign({Authorization:`Bearer ${r}`,"X-Api-Version":"2020-06-15","Content-Type":"application/json"},a);return this.axios.delete(e,{data:t,headers:i})}))}}},894:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FreeeFirebaseAuthClient=void 0;const a=r(786);t.FreeeFirebaseAuthClient=class{constructor(e,t,r,i,s){this.admin=e,this.oauth2=t,this.axios=r,this.tokenManager=i,this.clientId=a.ConfigManager.config.freee.client_id,this.clientSecret=a.ConfigManager.config.freee.client_secret,this.redirectPath=a.ConfigManager.getFreeeConfig(s,"redirectPath"),this.callbackPath=a.ConfigManager.getFreeeConfig(s,"callbackPath"),this.companiesPath=a.ConfigManager.getFreeeConfig(s,"companiesPath"),this.homePath=a.ConfigManager.getFreeeConfig(s,"homePath"),this.appHost=a.ConfigManager.getFreeeConfig(s,"appHost"),this.authHost=a.ConfigManager.getFreeeConfig(s,"authHost"),this.apiKey=s.firebase&&s.firebase.apiKey}redirect(e){const t=this.oauth2.authorizationCode.authorizeURL({redirect_uri:`${this.authHost}${this.getCallbackPath()}`});e.redirect(t)}async callback(e,t){try{const r=await this.oauth2.authorizationCode.getToken({client_id:this.clientId,client_secret:this.clientSecret,code:e,redirect_uri:`${this.authHost}${this.getCallbackPath()}`}),a={accessToken:r.access_token,refreshToken:r.refresh_token,expiresIn:r.expires_in,createdAt:r.created_at},i=await this.getFreeeUser(a.accessToken),s=i.data.user.id,n=i.data.user.email,o=i.data.user.display_name?i.data.user.display_name:"",c=await this.createFirebaseAccount(s,n,o,a);t.redirect(`${this.appHost}${this.homePath}?token=${c}`)}catch(e){console.error("Some error occured on login process:",e),t.send(this.signInRefusedTemplate())}}getRedirectPath(){return this.redirectPath}getCallbackPath(){return this.callbackPath}getCompaniesPath(){return this.companiesPath}async createCryptoKey(e){await this.tokenManager.createCryptoKey(e)}getFreeeUser(e){return this.axios.get("/api/1/users/me?companies=true",{headers:{Authorization:`Bearer ${e}`}})}async createFirebaseAccount(e,t,r,a){const i=e.toString();return await this.tokenManager.save(i,t,a),await this.admin.auth().updateUser(i,{email:t,displayName:r}).catch((async e=>{if("auth/user-not-found"===e.code)return await this.admin.auth().createUser({uid:i,email:t,displayName:r});throw e})),await this.admin.auth().createCustomToken(i)}signInRefusedTemplate(){return`\n      <script>\n        window.location.href = '${this.appHost}'\n      <\/script>`}}},313:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const a=r(938),i=r(675),s=r(850),n=r(894),o=r(786),c=r(745),h=r(791);t.default=class{constructor(e,t){this.admin=t?i.initializeApp({credential:i.credential.cert(t),databaseURL:`https://${t.project_id}.firebaseio.com`,storageBucket:`${t.project_id}.appspot.com`}):i.initializeApp();const u=o.ConfigManager.getFirebaseConfig(e,"cryptoKeyBucket"),p=u?new c.default(this.admin.storage().bucket(u)):null,d=r(886).create(this.getCredentials(e)),l=new h.TokenManager(this.admin,d,p);a.default.defaults.baseURL=o.ConfigManager.getFreeeConfig(e,"apiHost"),this.apiClient=new s.FreeeAPIClient(l,a.default),this.firebaseAuthClient=new n.FreeeFirebaseAuthClient(this.admin,d,a.default,l,e)}firebaseApp(){return this.admin}api(){return this.apiClient}auth(){return this.firebaseAuthClient}getCredentials(e){return{client:{id:o.ConfigManager.config.freee.client_id,secret:o.ConfigManager.config.freee.client_secret},auth:{tokenHost:o.ConfigManager.getFreeeConfig(e,"tokenHost"),authorizePath:o.ConfigManager.getFreeeConfig(e,"authorizePath"),tokenPath:o.ConfigManager.getFreeeConfig(e,"tokenPath")}}}}},786:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigManager=void 0;const a=r(701);(0,r(818).config)();const i=JSON.parse(process.env.FIREBASE_CONFIG).projectId,s=process.env.ENV_REGION&&a.SUPPORTED_REGIONS.includes(process.env.ENV_REGION)?process.env.ENV_REGION:"asia-northeast1",n={freee:{apiHost:"https://api.freee.co.jp",appHost:"http://localhost:5000",authHost:`http://localhost:5001/${i}/${s}/api/auth`,redirectPath:"/redirect",callbackPath:"/callback",companiesPath:"/companies",homePath:"/",tokenHost:"https://accounts.secure.freee.co.jp",authorizePath:"/public_api/authorize",tokenPath:"/public_api/token"},firebase:{cryptoKeyBucket:`${i}.appspot.com`}},o={freee:{appHost:`https://${i}.web.app`,authHost:`https://${s}-${i}.cloudfunctions.net/api/auth`,tokenHost:"https://accounts.secure.freee.co.jp"}};t.ConfigManager=class{static getFirebaseConfig(e,t){var r,a,i,s,c;return null!==(s=null!==(a=null===(r=null==e?void 0:e.firebase)||void 0===r?void 0:r[t])&&void 0!==a?a:this.isProduction?null===(i=o.firebase)||void 0===i?void 0:i[t]:void 0)&&void 0!==s?s:null===(c=n.firebase)||void 0===c?void 0:c[t]}static getFreeeConfig(e,t){var r,a,i,s;return null!==(s=null!==(a=null===(r=null==e?void 0:e.freee)||void 0===r?void 0:r[t])&&void 0!==a?a:this.isProduction?null===(i=o.freee)||void 0===i?void 0:i[t]:void 0)&&void 0!==s?s:n.freee[t]}static get config(){return{env:{mode:process.env.ENV_MODE||"production",region:s},freee:{client_id:process.env.FREEE_CLIENT_ID||"",client_secret:process.env.FREEE_CLIENT_SECRET||""}}}static get isProduction(){return"production"===this.config.env.mode}}},745:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});const a=r(172),i=r(749),s="aes-256-cbc",n="base64",o="utf8";t.default=class{constructor(e){this.bucket=e,this.keyCache={}}async createCryptoKey(e){const t=(0,a.format)(e,"yyyyMM");return this.create(t)}async encrypt(e){const{accessToken:t,refreshToken:r}=e,c=(0,a.format)(new Date,"yyyyMM"),h=await this.getKey(c),u=i.randomBytes(16);return Object.assign(Object.assign({},e),{accessToken:this.crypt(t,this.cipher(h,u),o,n),refreshToken:this.crypt(r,this.cipher(h,u),o,n),keyFileName:c,algorithm:s,iv:u})}async decrypt(e){const{accessToken:t,refreshToken:r,keyFileName:a,algorithm:i,iv:s}=e,c=await this.getKey(a);return Object.assign(Object.assign({},e),{accessToken:this.crypt(t,this.decipher(i,c,s),n,o),refreshToken:this.crypt(r,this.decipher(i,c,s),n,o)})}cipher(e,t){return i.createCipheriv(s,e,t)}decipher(e,t,r){return i.createDecipheriv(e,t,r)}async getKey(e){if(this.keyCache[e])return this.keyCache[e];try{return await this.get(e)}catch(t){return await this.exists(e)||(console.info("No key file for:",e),await this.create(e)),await this.get(e)}}crypt(e,t,r,a){let i=t.update(e,r,a);return i+=t.final(a),i}async create(e){const t=i.randomBytes(32),r=this.bucket.file(e);await r.save(t),console.log("New crypto key is successfully created for:",e)}async get(e){const t=await this.bucket.file(e).download();return this.keyCache[e]=t[0],console.log("Crypto key is retrieved from storage for:",e),t[0]}async exists(e){const t=(await this.bucket.file(e).exists())[0];return console.log(`Crypto key ${t?"is":"is not"} exists storage for:`,e),t}}},791:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TokenManager=void 0,t.TokenManager=class{constructor(e,t,r){this.admin=e,this.oauth2=t,this.cryptor=r,this.tokenCache={}}async get(e){const t=await this.getTokenFromFirebase(e);if(!this.tokenExpired(t))return t.accessToken;console.log("accessToken has been expired for user:",e);try{return await this.refreshToken(t,e)}catch(t){if(t.output&&401===t.output.statusCode){console.log("Token is already refreshed in other instance:",t);const r=await this.getTokenFromFirebase(e,!0);if(this.tokenExpired(r))throw console.error("Can not get available token:",t),t;return r.accessToken}throw t}}async save(e,t,r){const a=await this.encrypt(r);await this.admin.firestore().doc(`/freeeTokens/${e}`).set(Object.assign(Object.assign({},a),{email:t}))}async createCryptoKey(e){this.cryptor&&await this.cryptor.createCryptoKey(e)}async refreshToken(e,t){const r={access_token:e.accessToken,refresh_token:e.refreshToken,expires_in:e.expiresIn},a=this.oauth2.accessToken.create(r),i=await a.refresh(),s=await this.encrypt({accessToken:i.token.access_token,refreshToken:i.token.refresh_token,expiresIn:i.token.expires_in,createdAt:i.token.created_at});return this.tokenCache[t]=s,await this.admin.firestore().doc(`/freeeTokens/${t}`).set(Object.assign({},s),{merge:!0}),console.log("accessToken is successfully refreshed for user:",t),i.token.access_token}tokenExpired(e){const t=e.createdAt+e.expiresIn-300;return(new Date).getTime()/1e3>=t}async getTokenFromFirebase(e,t){if(!t){const t=this.tokenCache[e];if(t)return await this.decrypt(t)}const r=(await this.admin.firestore().doc(`/freeeTokens/${e}`).get()).data();return this.tokenCache[e]=r,console.log("Token is retrieved from firestore for user:",e),await this.decrypt(r)}async encrypt(e){return this.cryptor?await this.cryptor.encrypt(e):e}async decrypt(e){return this.cryptor?await this.cryptor.decrypt(e):e}}},938:e=>{e.exports=require("axios")},749:e=>{e.exports=require("crypto")},172:e=>{e.exports=require("date-fns")},818:e=>{e.exports=require("dotenv")},675:e=>{e.exports=require("firebase-admin")},701:e=>{e.exports=require("firebase-functions")},305:e=>{e.exports=require("form-data")},886:e=>{e.exports=require("simple-oauth2")}},t={};function r(a){var i=t[a];if(void 0!==i)return i.exports;var s=t[a]={exports:{}};return e[a](s,s.exports,r),s.exports}var a={};for(var i in(()=>{var e=a;Object.defineProperty(e,"__esModule",{value:!0}),e.FreeeServerSDK=void 0;const t=r(313);e.FreeeServerSDK=t.default})(),a)this[i]=a[i];a.__esModule&&Object.defineProperty(this,"__esModule",{value:!0})})();